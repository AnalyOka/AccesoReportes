<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Accesos a Reportes ‚Äî OKA</title>
  <style>
    :root{
      --oka-teal: #00d1c7;
      --oka-teal-2:#00c7bb;
      --oka-navy:#0b2b5c;
      --oka-lime:#e8ff5a;
      --bg:#f7f9fb;
      --card:#ffffff;
      --ink:#0e1a2b;
      --muted:#6b7a90;
      --border:#e4e8f1;
      --radius:18px;
      --shadow: 0 8px 24px rgba(13, 37, 62, .08);
      --shadow-sm: 0 2px 8px rgba(13, 37, 62, .06);
      --focus: 0 0 0 3px rgba(0,209,199,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }

    .topbar{
      background:var(--oka-teal);
      color:#001a33;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 22px; position:sticky; top:0; z-index:10;
      box-shadow: var(--shadow-sm);
    }
    .brand{display:flex;align-items:center;gap:14px}
    .brand img.logo{height:36px}
    .brand .pill{
      background:var(--oka-lime); color:#0b2b5c; font-weight:700;
      padding:6px 12px; border-radius:999px; font-size:13px;
    }

    .wrap{max-width:1100px;margin:28px auto;padding:0 18px}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:18px;
    }
    h2{margin:0 0 12px 0; font-size:22px}
    .row{display:flex; gap:18px; flex-wrap:wrap; margin-bottom:12px}
    label{font-weight:600; color:var(--ink)}
    .input, select, button, .file{
      border:1px solid var(--border); background:#fff; border-radius:12px;
      padding:10px 12px; font:inherit; color:inherit; outline:none;
      box-shadow:var(--shadow-sm)
    }
    .input:focus, select:focus{box-shadow:var(--focus)}
    .hint{color:var(--muted); font-size:12px}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
    .btn{
      background:var(--oka-navy); color:#fff; border:none; cursor:pointer;
      padding:10px 14px; border-radius:12px; font-weight:700
    }
    .btn.sec{background:#fff; color:var(--oka-navy); border:1px solid var(--oka-navy)}
    .btn:hover{filter:brightness(1.03)}
    .btn:focus{box-shadow:var(--focus)}

    .table-wrap{overflow:auto; border:1px solid var(--border); border-radius:14px}
    table{border-collapse:collapse; width:100%}
    th, td{border-bottom:1px solid var(--border); padding:10px; text-align:center}
    th:first-child, td:first-child{text-align:left}
    thead th{
      background:var(--oka-teal); color:#03224a; position:sticky; top:0; z-index:1
    }
    tr:hover td{background:#fbfdff}

    .persona-select{min-width:260px}
    .footer-note{display:flex; align-items:center; gap:10px; color:var(--muted); margin-top:14px}
    .mascota{height:34px}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <img src="logo.png" alt="OKA" class="logo" onerror="this.style.display='none'">
      <strong>Gesti√≥n de Accesos a Reportes</strong>
    </div>
    <span class="pill">Formulario interno</span>
  </div>

  <div class="wrap">
    <div class="card">
      <h2>Datos generales</h2>
      <div class="row">
        <div>
          <label for="lider">L√≠der de √°rea</label><br/>
          <input id="lider" class="input" placeholder="Ej. Gherson Torpoco">
        </div>
        <div>
          <label for="area">√Årea</label><br/>
          <select id="area">
            <option value="">Seleccionar</option>
          </select>
          <div class="hint">Opciones configurables en el bloque de JavaScript.</div>
        </div>
      </div>

      <div class="toolbar">
        <label class="btn sec" for="csvPersonas">Cargar personas (CSV)</label>
        <input id="csvPersonas" type="file" accept=".csv" style="display:none">
        <select id="addPersonaSelect" class="persona-select"></select>
        <button class="btn sec" id="btnAddPersona">+ Agregar persona</button>
        <button class="btn" id="btnExport">Exportar CSV</button>
        <button class="btn sec" id="btnClear">Limpiar</button>
        <!-- Nuevo bot√≥n -->
        <button class="btn" id="btnSend">Enviar a Sheets</button>
      </div>

      <div class="table-wrap">
        <table id="tabla">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="footer-note">
        <img src="mascota.png" class="mascota" alt="Mascota" onerror="this.style.display='none'">
        <span>Los cambios se guardan autom√°ticamente en este navegador.</span>
      </div>
    </div>
  </div>

  <script>
    /************* CONFIGURACI√ìN *************/
    const CONFIG = {
      areas: ["Comercial","Operaciones","Riesgos","Tecnolog√≠a","Finanzas","Cobranza"],
      reportes: ["Cobranzas","Conversion LD","FunnelConversion","PerformanceCosechas","PortafolioBNPL","Ventas","OKAMPEONES","FunnelLD_Cajas","Sistema financiero"],
      personasBase: ["Gherson Torpoco"],
      personasCatalogo: ["Ejemplo Persona - persona@oka.com.pe"],
      storageKey: "oka-form-accesos-v1"
    };

    /************* ESTADO *************/
    let state = { lider: "", area: "", personas: [], checks: {} };

    /************* UTILIDADES *************/
    const $ = (sel)=>document.querySelector(sel);
    const thead = $("#thead"), tbody = $("#tbody");
    const lider = $("#lider"), area = $("#area");
    const addPersonaSelect = $("#addPersonaSelect");
    function saveState(){ localStorage.setItem(CONFIG.storageKey, JSON.stringify(state)); }
    function loadState(){ const raw = localStorage.getItem(CONFIG.storageKey); if(raw){ try{ state = JSON.parse(raw)||state; }catch(e){} } }
    function key(persona, reporte){ return `${persona}|${reporte}`; }

    function setAreas(){
      CONFIG.areas.forEach(a=>{
        const opt=document.createElement("option"); opt.value=a; opt.textContent=a; area.appendChild(opt);
      });
    }
    function setPersonaSelect(){
      addPersonaSelect.innerHTML="";
      const opt0=document.createElement("option"); opt0.value=""; opt0.textContent="Seleccionar persona‚Ä¶";
      addPersonaSelect.appendChild(opt0);
      CONFIG.personasCatalogo.forEach(p=>{
        if(!state.personas.includes(p)){
          const o=document.createElement("option"); o.value=p; o.textContent=p; addPersonaSelect.appendChild(o);
        }
      });
    }

    function renderTable(){
      thead.innerHTML="";
      const trH=document.createElement("tr");
      const thP=document.createElement("th"); thP.textContent="Persona"; trH.appendChild(thP);
      CONFIG.reportes.forEach(r=>{ const th=document.createElement("th"); th.textContent=r; trH.appendChild(th); });
      thead.appendChild(trH);

      tbody.innerHTML="";
      state.personas.forEach(persona=>{
        const tr=document.createElement("tr");
        const tdName=document.createElement("td"); tdName.textContent=persona; tr.appendChild(tdName);
        CONFIG.reportes.forEach(reporte=>{
          const td=document.createElement("td");
          const chk=document.createElement("input"); chk.type="checkbox";
          chk.checked = !!state.checks[key(persona,reporte)];
          chk.addEventListener("change", ()=>{ state.checks[key(persona,reporte)] = chk.checked; saveState(); });
          td.appendChild(chk); tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function addPersona(nombre){
      if(!nombre || state.personas.includes(nombre)) return;
      state.personas.push(nombre);
      CONFIG.reportes.forEach(r=>{ if(state.checks[key(nombre,r)]===undefined) state.checks[key(nombre,r)] = false; });
      setPersonaSelect(); renderTable(); saveState();
    }

    function importCSVPersonas(file){
      const reader=new FileReader();
      reader.onload = ()=>{
        const text=reader.result;
        const rows=text.split(/\r?\n/).map(r=>r.trim()).filter(Boolean);
        if(rows.length===0) return;
        let start=0; if(rows[0].toLowerCase().includes("persona")) start=1;
        for(let i=start;i<rows.length;i++){
          const cols=rows[i].split(",").map(c=>c.trim()).filter(Boolean);
          const nombre=cols[0];
          if(nombre && !CONFIG.personasCatalogo.includes(nombre)) CONFIG.personasCatalogo.push(nombre);
        }
        setPersonaSelect();
        alert("Personas cargadas al cat√°logo. √ösalas con ‚ÄúAgregar persona‚Äù.");
      };
      reader.readAsText(file,"utf-8");
    }

    function exportCSV(){
      const cols=["lider","area","persona", ...CONFIG.reportes];
      const rows=[cols.join(",")];
      state.personas.forEach(p=>{
        const vals=[csv(lider.value), csv(area.value), csv(p)];
        CONFIG.reportes.forEach(r=>{ vals.push(state.checks[key(p,r)] ? "1":"0"); });
        rows.push(vals.join(","));
      });
      const blob=new Blob([rows.join("\n")],{type:"text/csv;charset=utf-8"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download="accesos_reportes_oka.csv";
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function csv(v){ const s=String(v??""); if(/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"'; return s; }
    function clearAll(){ if(!confirm("¬øBorrar datos locales del formulario?")) return;
      state={lider:"",area:"",personas:[],checks:{}}; lider.value=""; area.value="";
      setPersonaSelect(); renderTable(); saveState(); }

    /************* ENVIAR A SHEETS *************/
    const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbzsvpJ3_90pGwK2Xl4Fapeq-joE3nPkhvl8VCtw53TBVKcr3G1_K0dEVWHT-1A64upr/exec"; // üëà Reemplaza con tu enlace /exec

    function buildRowsForSheet(){
      return state.personas.map(p=>{
        const row={ lider:lider.value||"", area:area.value||"", persona:p };
        CONFIG.reportes.forEach((r,idx)=>{ row[`reporte_${idx+1}`]=!!state.checks[key(p,r)]; });
        return row;
      });
    }

    async function sendToSheets(){
      const rows = buildRowsForSheet();
      if(rows.length===0){ alert("No hay personas en la tabla."); return; }
      if(!area.value){ alert("Selecciona un √Årea antes de enviar."); return; }
  
      try{
        const params = new URLSearchParams();
        params.append("data", JSON.stringify({rows}));
  
        const res = await fetch(WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params.toString()
        });
  
        const data = await res.json();
        if(data.ok){
          alert(`Enviado correctamente: ${data.added} fila(s).`);
        }else{
          alert("Error al enviar: " + (data.error || "desconocido"));
        }
      }catch(err){
        alert("No se pudo conectar al endpoint.\n" + err);
      }
  }

    /************* INIT *************/
    loadState(); setAreas();
    lider.value=state.lider||""; area.value=state.area||"";
    lider.addEventListener("input", ()=>{ state.lider=lider.value; saveState(); });
    area.addEventListener("change", ()=>{ state.area=area.value; saveState(); });
    if(!state.personas||state.personas.length===0){ state.personas=[...CONFIG.personasBase];
      CONFIG.personasBase.forEach(p=>{ CONFIG.reportes.forEach(r=>{ state.checks[key(p,r)]=state.checks[key(p,r)]??false; }); }); }
    setPersonaSelect(); renderTable();
    document.getElementById("csvPersonas").addEventListener("change",(e)=>{ if(e.target.files?.[0]) importCSVPersonas(e.target.files[0]); e.target.value=""; });
    document.getElementById("btnAddPersona").addEventListener("click",()=>{ const val=addPersonaSelect.value; if(!val){ alert("Selecciona una persona."); return; } addPersona(val); addPersonaSelect.value=""; });
    document.getElementById("btnExport").addEventListener("click",exportCSV);
    document.getElementById("btnClear").addEventListener("click",clearAll);
    document.getElementById("btnSend").addEventListener("click",sendToSheets);
  </script>
</body>
</html>
